## DNS

![计算机网络 (2)](https://qraffa-1304595678.cos.ap-guangzhou.myqcloud.com/img/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%20(2).png)

### 简介

域名系统(Domain Name System，DNS)主要特点：

- 一个由分层的DNS服务器实现的分布式数据库
- 一个使得主机能够查询分布式数据库的应用层协议
- DNS协议运行在UDP上，端口号使用53

### DNS服务器设计

DNS的简单设计方案是使用单点集中式，即在网络上只使用一个DNS服务器，该服务器包含所有的映射，客户直接将所有的查询直接发往单一的DNS服务器，同时该DNS服务器直接对所有的查询客户做出响应。但存在显著的问题：

- 单点故障：如果只有一个DNS服务器，那么当该服务器出现故障时，整个网络随之瘫痪
- 通信容量：单个DNS服务器需要处理整个网络的所有DNS查询
- 远距离的集中式数据库：只有一个DNS服务器不可能对全球网络提供低延时的服务，存在物理上不可避免的延时
- 维护：单个DNS服务器需要维护保存整个网络的主机记录，这个数据库将非常庞大，并且需要频繁地更新

DNS使用分布式设计，使用了大量的服务器，以层次方式组织这些服务器，将服务器划分为根DNS服务器、顶级域(TLD)DNS服务器、权威DNS服务器

![DNS 层次结构](https://www.cloudflare.com/img/learning/dns/glossary/dns-root-server/dns-root-server.png)

- 根域名服务器：根域名服务器位于服务器层级的最顶层，这些根服务器只有13个IP地址，分别由13个不同的组织管理。根域名服务器提供TLD服务器的IP地址。在DNS解析器中内置了13个根服务器的IP地址。
- 顶级域服务器：对于每个顶级域(.com、.org、.net)和所有国家的顶级域(uk、.us、.ru)都有TLD服务器。TLD服务器提供了权威DNS服务器的IP地址。
- 权威服务器：具有公共可访问主机的每个组织机构必须提供公共可访问的DNS记录，这些记录将这些主机的名字映射为IP地址。一个组织机构的权威DNS服务器收藏了这些DNS记录。
- 本地DNS服务器：每个ISP都有一台本地DNS服务器，当主机与某个ISP连接时，该ISP提供一台主机的IP地址，该主机具有一台或多台其本地DNS服务器的IP地址。比如直连运营商网络的话，那么本地DNS服务器地址就是运营商提供的服务器地址；如果中间存在路由器等，那么此时的本地DNS服务器是指向路由器的地址。当主机发出DNS请求后，首先发送给该主机的本地DNS服务器，本地DNS服务器起着代理作用，将这些DNS请求转发到上述DNS层级的服务器中。

### DNS查询

1. 用户在 Web 浏览器中键入 “example.com”，查询传输到 Internet 中，并被 DNS 递归解析器接收。
2. 接着，解析器查询 DNS 根域名服务器（.）。
3. 然后，根服务器使用存储其域信息的顶级域（TLD）DNS 服务器（例如 .com 或 .net）的地址响应该解析器。在搜索 example.com 时，我们的请求指向 .com TLD。
4. 然后，解析器向 .com TLD 发出请求。
5. TLD 服务器随后使用该域的域名服务器 example.com 的 IP 地址进行响应。
6. 最后，递归解析器将查询发送到域的域名服务器。
7. example.com 的 IP 地址而后从域名服务器返回解析器。
8. 然后 DNS 解析器使用最初请求的域的 IP 地址响应 Web 浏览器。

​	DNS 查找的这 8 个步骤返回 example.com 的 IP 地址后，浏览器便能发出对该网页的请求：

1. 浏览器向该 IP 地址发出[ HTTP](https://www.cloudflare.com/learning/ddos/glossary/hypertext-transfer-protocol-http/) 请求。
2. 位于该 IP 的服务器返回将在浏览器中呈现的网页（第 10 步）。

![DNS 查询图](https://www.cloudflare.com/img/learning/dns/what-is-dns/dns-lookup-diagram.png)

递归查询：主机和本地DNS服务器的查询使用的是递归查询。在递归查询中DNS服务器执行递归并继续查询其他DNS服务器，直到找到IP地址并返回给客户端。

迭代查询：本地DNS服务器和各层级DNS服务器使用的是迭代查询。在迭代查询中，每个DNS查询都直接向客户端返回另一个需要查询的DNS服务器地址，然后客户端继续查询该返回的DNS服务器，直到得到查询域名的IP地址

### DNS缓存

DNS通过使用缓存来减少时延，减少网络中的DNS报文数量。

在DNS请求中，当DNS服务器接收到DNS响应后，能够将映射关系缓存到本地中，当下一次相同域名查询到达时，可以先检查本地的缓存，如果有就可以直接返回了。通常需要对缓存的映射关系设置过期时间。